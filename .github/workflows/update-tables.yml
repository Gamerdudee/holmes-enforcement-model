import fs from 'fs';

const file = 'enforcement-log.md';
const content = fs.readFileSync(file, 'utf8');
const lines = content.split('\n');

const violations = {};
const seen = new Set();
let currentEntity = null;

for (let i = 0; i < lines.length; i++) {
  const line = lines[i];
  const entityMatch = line.match(/^###\s+(.*)/);
  if (entityMatch) {
    currentEntity = entityMatch[1].trim();
    continue;
  }

  if (currentEntity) {
    const clauseMatch = line.match(/\*\*Clause(?:s)? (?:Triggered|Activated|Violated):\*\*\s*(.*)/i);
    if (clauseMatch) {
      const clauses = clauseMatch[1]
        .split(/[,/–]+/)
        .map(c => c.trim())
        .filter(Boolean);

      if (!violations[currentEntity]) violations[currentEntity] = {};

      clauses.forEach(clause => {
        const key = `${currentEntity}::${clause}`;
        if (seen.has(key)) return; // Deduplication
        seen.add(key);

        if (!violations[currentEntity][clause]) violations[currentEntity][clause] = 0;
        violations[currentEntity][clause]++;
      });

      currentEntity = null;
    }
  }
}

// 📊 Generate Summary Table
let summaryTable = `## 🤖 Auto Summary Table\n\n| Entity | Violation Summary | Triggered Clauses | Status |\n|--------|-------------------|-------------------|--------|\n`;
for (const [entity, clauses] of Object.entries(violations)) {
  const clauseList = Object.entries(clauses)
    .map(([c, count]) => `${c} (${count})`)
    .join(', ');
  summaryTable += `| ${entity} | Patterned usage | ${clauseList} | Auto-logged |\n`;
}

// ⏱ Generate Trigger Timeline
let timelineTable = `\n## ⏱ Auto Trigger Timeline\n\n| Entity | Clauses | Last Seen |\n|--------|---------|-----------|\n`;
for (const [entity, clauses] of Object.entries(violations)) {
  const clauseList = Object.keys(clauses).join(', ');
  timelineTable += `| ${entity} | ${clauseList} | [auto] |\n`;
}

// 🗓️ Add Monthly Banner
const now = new Date();
const monthName = now.toLocaleString('default', { month: 'long' });
const banner = `📅 ${monthName} ${now.getFullYear()} — This Month's Summary\n`;

const startMarker = '<!-- START: AutoTables -->';
const endMarker = '<!-- END: AutoTables -->';
const newBlock = `${startMarker}\n\n## ${banner}\n\n${summaryTable}\n${timelineTable}\n\n${endMarker}`;

// 🧼 Replace block in enforcement-log.md
const updated = content.replace(
  new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`),
  newBlock
);

fs.writeFileSync(file, updated);
console.log('✅ Enforcement tables and monthly banner updated.');
