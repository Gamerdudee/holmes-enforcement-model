name: SPDX Header Audit

on:
  push:
    paths:
      - '**.md'
      - '**.sol'
      - '**.json'
      - '**.js'
      - '**.ts'
      - '**.cjs'
      - '**.sh'
      - '**.py'
  pull_request:
    paths:
      - '**.md'
      - '**.sol'
      - '**.json'
      - '**.js'
      - '**.ts'
      - '**.cjs'
      - '**.sh'
      - '**.py'

jobs:
  check-spdx-headers:
    runs-on: ubuntu-latest
    name: Check for SPDX headers

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Search for missing SPDX headers
        shell: bash
        run: |
          echo "üîç Checking for SPDX headers in tracked file types..."

          missing=""

          find . -type f \( \
              -name '*.md' -o -name '*.sol' -o -name '*.json' -o -name '*.js' -o \
              -name '*.ts' -o -name '*.cjs' -o -name '*.sh' -o -name '*.py' \
            \) \
            ! -path './.git/*' \
            ! -path './.github/*' \
            ! -name '*.png' \
            ! -name '*.jpg' \
            ! -name '*.jpeg' \
            ! -name '*.svg' -print0 |
          while IFS= read -r -d '' file; do
            echo "Checking file: [$file]"
            if ! grep -q 'SPDX-License-Identifier: Declaratory-Royalty' "$file"; then
              missing+="$file"$'\n'
            fi
          done

          if [ -n "$missing" ]; then
            echo ""
            echo "üö® Files missing SPDX headers:"
            echo "$missing"
            echo ""
            echo "‚ö†Ô∏è Please add this line to the top of each file:"
            echo "// SPDX-License-Identifier: Declaratory-Royalty"
            exit 1
          else
            echo "‚úÖ All applicable files contain SPDX headers."
          fi
